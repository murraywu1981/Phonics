<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è‡ªç„¶æ‹¼è¯» Pro - V19 äº‘åŒæ­¥ç‰ˆ</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.4.21/mammoth.browser.min.js"></script>
    <style>
        :root {
            --primary: #7b61ff;
            --success: #52c41a;
            --success-bg: #d9f7be;
            --danger: #ff4d4f;
            --bg: #f5f7fa;
            --font-mono: "Consolas", "Monaco", "Courier New", monospace; 
        }

        body { font-family: 'Segoe UI', sans-serif; background-color: var(--bg); margin: 0; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        .view-section { display: none; height: 100%; width: 100%; flex-direction: column; }
        .view-section.active { display: flex; }
        .dashboard-container { padding: 40px; max-width: 1000px; margin: 0 auto; width: 100%; overflow-y: auto; }
        
        .key-hint { display: inline-block; padding: 2px 8px; border: 1px solid #ccc; border-radius: 5px; font-size: 12px; color: #999; margin-left: 5px; background: #fff; }
        .stats-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin: 30px 0; }
        .stat-card { background: white; padding: 25px; border-radius: 15px; text-align: center; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        .stat-num { font-size: 36px; font-weight: 800; color: var(--primary); }
        .menu-btn { font-size: 18px; padding: 15px 40px; border-radius: 50px; border: none; cursor: pointer; font-weight: bold; margin: 0 10px; transition: transform 0.2s; position: relative; }
        .menu-btn:hover { transform: translateY(-3px); }
        .btn-primary { background: var(--primary); color: white; }
        .header { background: white; padding: 15px 40px; display: flex; justify-content: space-between; align-items: center; height: 60px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .step-indicators { display: flex; gap: 40px; }
        .step-ind { font-size: 20px; color: #ddd; font-weight: bold; transition: 0.3s; }
        .step-ind.active { color: var(--primary); transform: scale(1.1); }
        .stage { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative; gap: 40px; }
        .instruction { font-size: 28px; color: #888; font-weight: 500; margin-top: 20px; }

        /* äº‘åŒæ­¥ä¸æ•°æ®ç®¡ç†åŒº */
        .data-management { margin-top: 40px; padding-top: 30px; border-top: 2px dashed #e0e0e0; text-align: center; color: #666; }
        .data-btn { background: white; border: 1px solid #ccc; padding: 8px 20px; border-radius: 20px; cursor: pointer; margin: 0 10px; font-size: 14px; color: #555; transition: all 0.2s; }
        .data-btn:hover { border-color: var(--primary); color: var(--primary); }
        
        .cloud-panel { background: #f0f5ff; padding: 20px; border-radius: 15px; margin-top: 20px; display: none; }
        .cloud-panel.show { display: block; animation: fadeIn 0.3s; }
        .cloud-input { padding: 10px; width: 300px; border-radius: 5px; border: 1px solid #ccc; }
        .btn-cloud { background: var(--primary); color: white; border: none; }

        @keyframes fadeIn { from{opacity:0;transform:translateY(-10px)} to{opacity:1;transform:translateY(0)} }

        /* è¾“å…¥æ¡†ç»„ä»¶ */
        .rich-input-wrapper { 
            position: relative; display: inline-block; margin: 0 10px; 
            background: white; border-radius: 20px; border: 5px solid #ccc;
            box-shadow: 0 8px 20px rgba(0,0,0,0.08); cursor: text;
            transition: all 0.2s;
        }
        .visual-layer { 
            font-family: var(--font-mono); font-size: 80px; font-weight: 800; 
            text-align: center; width: 100%; height: 100%; line-height: 160px; 
            position: absolute; top: 0; left: 0; z-index: 1;
            pointer-events: none; white-space: pre;
            background: transparent !important; 
        }
        .ghost-input { 
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 10; 
            opacity: 0 !important; cursor: text; padding: 0; margin: 0; border: none;
        }
        .cursor {
            display: inline-block; width: 4px; height: 80px; background-color: #333;
            vertical-align: middle; margin-bottom: 12px; animation: blink 1s step-end infinite;
        }
        .ghost-input:not(:focus) + .visual-layer .cursor { display: none; }
        @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0; } }
        .rich-input-wrapper:focus-within { border-color: var(--primary); box-shadow: 0 0 0 6px rgba(123,97,255,0.2); }
        .rich-input-wrapper.correct { 
            border-color: var(--success) !important; 
            background-color: var(--success-bg) !important; 
            box-shadow: 0 0 30px rgba(82, 196, 26, 0.5) !important;
            transform: scale(1.05); 
        }
        .rich-input-wrapper.correct .c { color: #0050b3; } 
        .rich-input-wrapper.correct .v { color: #cf1322; }
        .rich-input-wrapper.error { border-color: var(--danger); animation: shake 0.4s; }
        .v { color: #ff4d4f; font-weight: 900; } 
        .c { color: #1890ff; } 
        @keyframes shake { 0%,100%{transform:translateX(0);} 25%{transform:translateX(-10px);} 75%{transform:translateX(10px);} }
        .enter-tip { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); color: #aaa; font-size: 14px; opacity: 0; transition: 0.3s; }
        .enter-tip.show { opacity: 1; }
        .summary-card { background: white; padding: 40px; border-radius: 20px; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
        .drop-zone { border: 3px dashed #ccc; padding: 40px; background: white; margin: 20px auto; max-width: 600px; cursor: pointer; text-align: center; }
    </style>
</head>
<body>

    <div id="view-dashboard" class="view-section active">
        <div class="dashboard-container">
            <h1 style="text-align:center; color:#333;">ğŸ“š è‡ªç„¶æ‹¼è¯» Pro</h1>
            <p style="text-align:center; color:#666;">ä»Šæ—¥å¾…å­¦ï¼š<b id="daily-target" style="color:var(--primary)">0</b> è¯</p>
            <div class="stats-grid">
                <div class="stat-card"><span class="stat-num" id="stat-total">0</span><br>æ€»è¯åº“</div>
                <div class="stat-card"><span class="stat-num" id="stat-learned" style="color:var(--success)">0</span><br>å·²æŒæ¡</div>
                <div class="stat-card"><span class="stat-num" id="stat-remain" style="color:#faad14">0</span><br>æœªå­¦ä¹ </div>
                <div class="stat-card"><span class="stat-num" id="stat-mistakes" style="color:var(--danger)">0</span><br>é”™é¢˜æœ¬</div>
            </div>
            <div style="text-align:center; margin-bottom:20px;">
                <label>è®¡åˆ’ï¼š<input type="number" id="plan-days" value="21" style="width:50px;text-align:center" onchange="App.saveConfig()"> å¤©</label>
                &nbsp;&nbsp;
                <select id="learn-order"><option value="random">éšæœºä¹±åº</option><option value="sequence">åˆ—è¡¨é¡ºåº</option></select>
            </div>
            <div style="text-align:center;">
                <button class="menu-btn btn-primary" onclick="App.start('daily')">ğŸš€ å¼€å§‹ç»ƒä¹  <span class="key-hint">Enter</span></button>
                <button class="menu-btn" style="color:var(--danger); border:2px solid var(--danger); background:white;" onclick="App.start('review')">ğŸ’Š å¤ä¹ é”™é¢˜</button>
                <button class="menu-btn" style="border:2px solid #ddd; background:white;" onclick="App.switchView('import')">ğŸ“‚ å¯¼å…¥æ–°è¯</button>
            </div>

            <!-- æ•°æ®ç®¡ç† -->
            <div class="data-management">
                <div style="margin-bottom:15px;">
                    <button class="data-btn" onclick="document.getElementById('cloud-panel').classList.toggle('show')">â˜ï¸ GitHub äº‘åŒæ­¥</button>
                    <button class="data-btn" onclick="DataManager.exportData()">â¬‡ï¸ æœ¬åœ°å¤‡ä»½</button>
                    <button class="data-btn" onclick="document.getElementById('backup-input').click()">â¬†ï¸ æœ¬åœ°æ¢å¤</button>
                    <button class="data-btn" style="color:red; border-color:red;" onclick="DataManager.resetData()">âš ï¸ æ¸…ç©ºé‡ç½®</button>
                </div>

                <!-- äº‘åŒæ­¥é¢æ¿ -->
                <div id="cloud-panel" class="cloud-panel">
                    <p style="font-size:14px;">è¯·è¾“å…¥æ‚¨çš„ GitHub Token (ä»¥ ghp_ å¼€å¤´)ï¼š</p>
                    <input type="password" id="github-token" class="cloud-input" placeholder="åœ¨æ­¤ç²˜è´´ Token">
                    <div style="margin-top:15px;">
                        <button class="data-btn btn-cloud" onclick="CloudManager.upload()">â¬†ï¸ ä¸Šä¼ è¿›åº¦åˆ°äº‘ç«¯</button>
                        <button class="data-btn btn-cloud" onclick="CloudManager.download()">â¬‡ï¸ ä»äº‘ç«¯ä¸‹è½½è¿›åº¦</button>
                    </div>
                    <p id="cloud-status" style="font-size:12px; margin-top:10px; color:#666;"></p>
                </div>

                <input type="file" id="backup-input" hidden accept=".json" onchange="DataManager.importData(this.files[0])">
            </div>
        </div>
    </div>

    <!-- å¯¼å…¥ç•Œé¢ -->
    <div id="view-import" class="view-section">
        <div class="dashboard-container">
            <h2 style="text-align:center">å¯¼å…¥æ–°å•è¯</h2>
            <div class="drop-zone" onclick="document.getElementById('file-input').click()">
                <div style="font-size:30px">ğŸ“„</div><div>ç‚¹å‡»ä¸Šä¼  Word / Txt</div>
                <div id="file-name" style="color:var(--primary); margin-top:10px; font-weight:bold;"></div>
            </div>
            <input type="file" id="file-input" hidden accept=".docx,.txt" onchange="Importer.handleFile(this.files[0])">
            <textarea id="manual-text" placeholder="æ ¼å¼: hand/some è‹±ä¿Šçš„" style="width:100%; height:150px; margin:20px 0; padding:10px; font-family: monospace;"></textarea>
            <div style="text-align:center;">
                <button class="menu-btn btn-primary" onclick="Importer.parseManual()">ç¡®å®š</button>
                <button class="menu-btn" onclick="App.switchView('dashboard')">è¿”å›</button>
            </div>
        </div>
    </div>

    <!-- ç»ƒä¹ ç•Œé¢ -->
    <div id="view-practice" class="view-section">
        <div class="header">
            <button onclick="App.endSession()" style="padding:5px 15px; cursor:pointer;">Esc é€€å‡º</button>
            <div class="step-indicators"><div id="ind-1" class="step-ind">1. è¯»</div><div id="ind-2" class="step-ind">2. åˆ†</div><div id="ind-3" class="step-ind">3. å†™</div></div>
            <div>å‰©ä½™: <b id="remain-count">0</b></div>
        </div>
        <div class="stage" id="stage"></div>
        <div id="enter-tip" class="enter-tip">æŒ‰ Enter ä¸‹ä¸€æ­¥</div>
    </div>

    <script>
        const DICT = {"apple":"è‹¹æœ","banana":"é¦™è•‰","cat":"çŒ«","dog":"ç‹—","elephant":"å¤§è±¡","fish":"é±¼","girl":"å¥³å­©","hello":"ä½ å¥½","ice":"å†°","juice":"æœæ±","kite":"é£ç­","lion":"ç‹®å­","monkey":"çŒ´å­","nose":"é¼»å­","orange":"æ©™å­","pig":"çŒª","queen":"å¥³ç‹","rabbit":"å…”å­","sun":"å¤ªé˜³","tiger":"è€è™","umbrella":"é›¨ä¼","van":"è´§è½¦","water":"æ°´","box":"ç›’å­","yellow":"é»„è‰²","zoo":"åŠ¨ç‰©å›­","welcome":"æ¬¢è¿","student":"å­¦ç”Ÿ","teacher":"è€å¸ˆ","school":"å­¦æ ¡","pizza":"æŠ«è¨","hamburger":"æ±‰å ¡","computer":"ç”µè„‘","friend":"æœ‹å‹"};

        const DB = {
            key: 'phonics_pro_v19_cloud',
            data: { lib: [], config: { planDays: 21 } },
            load() { const r = localStorage.getItem(this.key); if(r) this.data = JSON.parse(r); },
            save() { localStorage.setItem(this.key, JSON.stringify(this.data)); App.updateUI(); },
            add(list) {
                let c = 0;
                list.forEach(i => {
                    if(!this.data.lib.find(w=>w.word===i.word)) {
                        let trans = i.trans || DICT[i.word] || "æš‚æ— é‡Šä¹‰";
                        const finalChunks = i.chunks || this.split(i.word);
                        this.data.lib.push({ word: i.word, trans: trans, chunks: finalChunks, status: 0, err: 0 });
                        c++;
                    }
                });
                alert(`å¯¼å…¥ ${c} è¯`); this.save();
            },
            split(w) { return w.length<=4 ? [w] : (w.toLowerCase().match(/[^aeiouy]*[aeiouy]+(?:[^aeiouy]*$|[^aeiouy](?=[^aeiouy]))?/gi) || [w]); }
        };

        // ==================== GitHub äº‘åŒæ­¥ç®¡ç†å™¨ ====================
        const CloudManager = {
            GIST_FILENAME: "phonics_pro_data.json",
            
            async upload() {
                const token = document.getElementById('github-token').value.trim();
                if(!token) return alert("è¯·è¾“å…¥ GitHub Token");
                
                this.setStatus("æ­£åœ¨è¿æ¥ GitHub...");
                
                try {
                    // 1. æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨ Gist
                    const gists = await this.fetchGists(token);
                    let targetGist = gists.find(g => g.files[this.GIST_FILENAME]);
                    
                    const content = JSON.stringify(DB.data);
                    
                    if(targetGist) {
                        // æ›´æ–°
                        this.setStatus("æ­£åœ¨ä¸Šä¼ æ•°æ®...");
                        await this.updateGist(token, targetGist.id, content);
                        alert("âœ… äº‘ç«¯åŒæ­¥æˆåŠŸï¼(å·²æ›´æ–°)");
                    } else {
                        // åˆ›å»º
                        this.setStatus("æ­£åœ¨åˆ›å»ºäº‘ç«¯å­˜æ¡£...");
                        await this.createGist(token, content);
                        alert("âœ… äº‘ç«¯åŒæ­¥æˆåŠŸï¼(æ–°åˆ›å»º)");
                    }
                    this.setStatus("");
                    // ä¿å­˜Tokenæ–¹ä¾¿ä¸‹æ¬¡ä½¿ç”¨
                    localStorage.setItem('phonics_gh_token', token);
                } catch(e) {
                    alert("âŒ åŒæ­¥å¤±è´¥ï¼š" + e.message);
                    this.setStatus("å¤±è´¥");
                }
            },

            async download() {
                const token = document.getElementById('github-token').value.trim();
                if(!token) return alert("è¯·è¾“å…¥ GitHub Token");
                this.setStatus("æ­£åœ¨æŸ¥æ‰¾äº‘ç«¯æ•°æ®...");
                
                try {
                    const gists = await this.fetchGists(token);
                    const targetGist = gists.find(g => g.files[this.GIST_FILENAME]);
                    
                    if(!targetGist) throw new Error("æœªæ‰¾åˆ°äº‘ç«¯å­˜æ¡£ï¼Œè¯·å…ˆä¸Šä¼ ã€‚");
                    
                    const fileUrl = targetGist.files[this.GIST_FILENAME].raw_url;
                    const res = await fetch(fileUrl);
                    const cloudData = await res.json();
                    
                    if(confirm("âš ï¸ ç¡®å®šè¦ç”¨äº‘ç«¯æ•°æ®è¦†ç›–æœ¬åœ°æ•°æ®å—ï¼Ÿ")) {
                        DB.data = cloudData;
                        DB.save();
                        alert("âœ… ä¸‹è½½å¹¶è¦†ç›–æˆåŠŸï¼");
                    }
                    this.setStatus("");
                    localStorage.setItem('phonics_gh_token', token);
                } catch(e) {
                    alert("âŒ ä¸‹è½½å¤±è´¥ï¼š" + e.message);
                    this.setStatus("å¤±è´¥");
                }
            },

            // API è¾…åŠ©å‡½æ•°
            async fetchGists(token) {
                const res = await fetch('https://api.github.com/gists', {
                    headers: { 'Authorization': `token ${token}` }
                });
                if(!res.ok) throw new Error("Token æ— æ•ˆæˆ–ç½‘ç»œé”™è¯¯");
                return await res.json();
            },
            async createGist(token, content) {
                const files = {}; files[this.GIST_FILENAME] = { content: content };
                await fetch('https://api.github.com/gists', {
                    method: 'POST',
                    headers: { 'Authorization': `token ${token}` },
                    body: JSON.stringify({ description: "Phonics Pro Data", public: false, files: files })
                });
            },
            async updateGist(token, id, content) {
                const files = {}; files[this.GIST_FILENAME] = { content: content };
                await fetch(`https://api.github.com/gists/${id}`, {
                    method: 'PATCH',
                    headers: { 'Authorization': `token ${token}` },
                    body: JSON.stringify({ files: files })
                });
            },
            setStatus(msg) { document.getElementById('cloud-status').innerText = msg; }
        };

        // æœ¬åœ°æ•°æ®ç®¡ç†
        const DataManager = {
            exportData() {
                const blob = new Blob([JSON.stringify(DB.data)], {type: "application/json"});
                const a = document.createElement('a');
                a.href = URL.createObjectURL(blob);
                a.download = `phonics_backup.json`;
                a.click();
            },
            importData(file) {
                if(!file) return;
                const r = new FileReader();
                r.onload = e => {
                    try { DB.data = JSON.parse(e.target.result); DB.save(); alert("æ¢å¤æˆåŠŸ"); }
                    catch(err) { alert("æ–‡ä»¶é”™è¯¯"); }
                };
                r.readAsText(file);
            },
            resetData() {
                if(confirm("âš ï¸ è­¦å‘Šï¼šæ¸…ç©ºæ‰€æœ‰æ•°æ®ï¼Ÿ")) { localStorage.removeItem(DB.key); location.reload(); }
            }
        };

        // Importer, Practice, App é€»è¾‘ä¿æŒä¸å˜ (å¤ç”¨ V18)
        const Importer = {
            handleFile(f) {
                if(!f) return; document.getElementById('file-name').innerText = f.name;
                const r = new FileReader();
                if(f.name.endsWith('.docx')) r.onload = e => mammoth.extractRawText({arrayBuffer:e.target.result}).then(x=>this.parse(x.value));
                else r.onload = e => this.parse(e.target.result);
                f.name.endsWith('.docx') ? r.readAsArrayBuffer(f) : r.readAsText(f);
            },
            parseManual() { this.parse(document.getElementById('manual-text').value); },
            parse(txt) {
                const list = [];
                txt.split(/[\r\n]+/).forEach(l => {
                    const p = l.trim().split(/\s+/);
                    if(p.length===0 || !p[0]) return;
                    let w="", c=null, t="";
                    const sp = p.find(x=>x.includes('/'));
                    if(sp) {
                        c = sp.split('/').map(s=>s.toLowerCase()); w = c.join('');
                        t = p.filter(x=>x!==sp && x.toLowerCase()!==w).join(' ');
                    } else {
                        if(/[a-zA-Z]/.test(p[0])) { w=p[0].toLowerCase(); t=p.slice(1).join(' '); }
                    }
                    if(w) list.push({word:w, chunks:c, trans:t});
                });
                if(list.length) { DB.add(list); App.switchView('dashboard'); } else alert("æ ¼å¼é”™è¯¯");
            }
        };

        const Practice = {
            queue: [], idx: 0, step: 1, canNext: false, sessionErr: 0, mode: 'learning', currentWordHasError: false, 
            start(list, mode) { this.queue = list; this.idx = 0; this.sessionErr = 0; this.mode = mode; this.loadWord(0); document.addEventListener('keydown', this.handleKey); },
            stop() { document.removeEventListener('keydown', this.handleKey); App.switchView('dashboard'); },
            handleKey(e) {
                if(e.key === 'Escape') { App.endSession(); return; }
                if(Practice.mode !== 'summary' && e.key === 'Enter') { if(Practice.canNext) Practice.next(); }
            },
            loadWord(i) { this.idx = i; this.step = 1; this.canNext = false; this.currentWordHasError = false; document.getElementById('remain-count').innerText = this.queue.length - i; this.render(); },
            setCanNext(b) { this.canNext = b; document.getElementById('enter-tip').classList.toggle('show', b); },
            render() {
                const data = this.queue[this.idx]; const stage = document.getElementById('stage'); stage.innerHTML = '';
                [1,2,3].forEach(n => document.getElementById(`ind-${n}`).className = `step-ind ${n===this.step?'active':''}`);
                if(this.step===1) {
                    this.setCanNext(true);
                    stage.innerHTML = `<div style="display:flex;gap:15px">${data.chunks.map(c=>`<div class="rich-input-wrapper" style="width:${Math.max(120,c.length*70)}px;height:160px;border-color:var(--primary)"><div class="visual-layer" style="line-height:160px">${this.color(c)}</div></div>`).join('')}</div><div class="instruction">${data.trans||"æš‚æ— "}</div>`;
                    setTimeout(()=>this.speak(data.word),100);
                } else if(this.step===2) {
                    this.setCanNext(false);
                    const box=document.createElement('div'); box.style.display='flex'; box.style.alignItems='center';
                    data.chunks.forEach((c,k)=>{
                        if(k>0) { const s=document.createElement('div'); s.innerHTML='-'; s.style.fontSize='40px'; s.style.color='#ccc'; s.style.margin='0 10px'; box.appendChild(s); }
                        const {wrapper,input}=this.createGhostInput(c.length,`s${k}`); input.disabled=(k!==0);
                        input.addEventListener('input',()=>{
                            if(input.value.toLowerCase()===c) { wrapper.classList.add('correct'); input.disabled=true; const n=document.getElementById(`s${k+1}`); if(n){n.disabled=false;n.focus();this.speak(data.chunks[k+1]);}else{this.setCanNext(true);this.speak('Good');} }
                            else if(input.value.length>=c.length) this.triggerError(wrapper);
                        });
                        input.addEventListener('keydown',e=>{if(e.key==='Enter')e.preventDefault()}); box.appendChild(wrapper);
                    });
                    stage.appendChild(box); stage.innerHTML+=`<div class="instruction">åˆ†æ®µæ‹¼å†™</div>`;
                    setTimeout(()=>{const f=document.getElementById('s0');if(f)f.focus();this.speak(data.chunks[0]);},100);
                } else if(this.step===3) {
                    this.setCanNext(false);
                    const {wrapper,input}=this.createGhostInput(data.word.length,'full'); wrapper.style.width='700px';
                    input.addEventListener('keydown',e=>{
                        if(e.key==='Enter') { e.stopPropagation();
                            if(this.canNext){Practice.next();return;}
                            if(input.value.toLowerCase()===data.word){wrapper.classList.add('correct');input.disabled=true;this.saveResult(data);this.speak('Excellent');this.setCanNext(true);}
                            else{this.triggerError(wrapper);}
                        }
                    });
                    stage.appendChild(wrapper); stage.innerHTML+=`<div class="instruction">å¬éŸ³é»˜å†™</div>`;
                    setTimeout(()=>{input.focus();this.speak(data.word);},100);
                }
            },
            createGhostInput(l,id){
                const w=document.createElement('div');w.className='rich-input-wrapper';w.style.width=Math.max(140,l*70)+'px';w.style.height='160px';
                const i=document.createElement('input');i.className='ghost-input';i.maxLength=l;i.id=id;i.autocomplete="off";
                const v=document.createElement('div');v.className='visual-layer';v.innerHTML=`<span class="cursor"></span>`;
                i.addEventListener('input',()=>{let h=this.color(i.value);if(i.value.length<l)h+=`<span class="cursor"></span>`;v.innerHTML=h;});
                w.append(i,v); return {wrapper:w,input:i};
            },
            triggerError(w){ w.classList.add('error'); this.speak('Try again'); this.currentWordHasError=true; const i=DB.data.lib.find(x=>x.word===this.queue[this.idx].word); if(i)i.err++; DB.save(); setTimeout(()=>{this.step=1;this.render();},1000); },
            saveResult(d){ const i=DB.data.lib.find(x=>x.word===d.word); if(i){ if(this.mode==='review'&&!this.currentWordHasError&&i.err>0)i.err--; i.status=1; DB.save(); } },
            next(){ if(this.step<3){this.step++;this.render();}else{if(this.idx<this.queue.length-1)this.loadWord(this.idx+1);else this.showSummary();} },
            showSummary(){ this.mode='summary'; document.getElementById('stage').innerHTML=`<div class="summary-card"><h1>ğŸ‰ å®Œæˆ</h1><p style="color:#999">æŒ‰ Enter è¿”å›</p></div>`; this.setCanNext(false); },
            color(t){return t?t.split('').map(c=>`<span class="${/[aeiouy]/i.test(c)?'v':'c'}">${c}</span>`).join(''):'';},
            speak(t){window.speechSynthesis.cancel();const u=new SpeechSynthesisUtterance(t);u.lang='en-US';u.rate=1.0;window.speechSynthesis.speak(u);}
        };

        const App = {
            init() { 
                DB.load(); this.updateUI(); 
                const t = localStorage.getItem('phonics_gh_token'); if(t) document.getElementById('github-token').value = t;
                document.addEventListener('keydown', e => { if(document.getElementById('view-dashboard').classList.contains('active') && e.key === 'Enter') App.start('daily'); });
            },
            switchView(id) { document.querySelectorAll('.view-section').forEach(e=>e.classList.remove('active')); document.getElementById('view-'+id).classList.add('active'); this.updateUI(); },
            updateUI() {
                const l = DB.data.lib;
                document.getElementById('stat-total').innerText = l.length;
                document.getElementById('stat-learned').innerText = l.filter(w=>w.status==1).length;
                document.getElementById('stat-remain').innerText = l.filter(w=>w.status==0).length;
                document.getElementById('stat-mistakes').innerText = l.filter(w=>w.err>0).length;
                document.getElementById('daily-target').innerText = Math.ceil(l.filter(w=>w.status==0).length / DB.data.config.planDays) || 0;
            },
            saveConfig() { DB.data.config.planDays = document.getElementById('plan-days').value; DB.save(); },
            start(mode) {
                const l = DB.data.lib; let list = [];
                if(mode==='daily') {
                    let p = l.filter(w=>w.status==0);
                    if(!p.length) { if(confirm("æ–°è¯å·²å­¦å®Œï¼æ˜¯å¦å¤ä¹ ï¼Ÿ")) p=l.filter(w=>w.status==1); else return; }
                    const c = parseInt(document.getElementById('daily-target').innerText)||10; const r=document.getElementById('learn-order').value==='random';
                    list = r ? p.sort(()=>0.5-Math.random()).slice(0,c) : p.slice(0,c);
                } else { list = l.filter(w=>w.err>0); if(!list.length) return alert("æ— é”™é¢˜"); }
                App.switchView('practice'); Practice.start(list, mode);
            },
            endSession() { if(confirm("é€€å‡º?")) { Practice.stop(); App.switchView('dashboard'); } }
        };
        App.init();
    </script>
</body>
</html>
